<!--suppress JSAnnotator -->
<template>
    <div class="page " data-name="home"> <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="/panel-left/" class="link icon-only " >
                        <i class="icon material-icons">menu</i>
                    </a>
                </div>
                <div class="title sliding">
                    {{@global.LANGUAGE.HOME_MSG00}}
                </div>
                <div class="right">
                    <div class="right">
                        <a href="#" @click="refreshMap" class="link icon-only">
                            <i class="f7-icons icon-refresh-map"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-content">
            <a href="#" class="float-panic-button panicButton">
                <img src="resources/images/panic.svg" alt="">
            </a>
            <div class="home-map-wrapper">
                <div id="homeMap" class="map"></div>

                <div class="fab fab-right-bottom fab-custom ">
                    <a href="#" class="bg-color-custom elevation-hover-10 flex-direction-column shareButton" data-lat="{{Lat}}" data-lng="{{Lng}}">
                        <i class="f7-icons icon-share"></i>
                        <div class="fab-text">{{@global.LANGUAGE.COM_MSG028}}</div>
                    </a>
                </div>
            </div>
            <div class="list no-margin no-hairlines no-hairlines-between">
                <ul>
                    <li>
                        <div class="item-content text-color-custom">
                            <div class="item-media">{{@global.LANGUAGE.HOME_MSG01}}</div>
                            <div class="item-inner">
                                <div class="item-title">{{Name}}</div>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="item-content">
                            <div class="item-media">{{@global.LANGUAGE.HOME_MSG02}}</div>
                            <div class="item-inner">
                                <div class="item-title">{{Phone}}</div>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="item-content">
                            <div class="item-media">{{@global.LANGUAGE.HOME_MSG03}}</div>
                            <div class="item-inner">
                                <div class="item-title">{{Email}}</div>
                            </div>
                        </div>
                    </li>
                    <li class="item-divider only-line"></li>
                    <li>
                        <div class="item-content">
                            <div class="item-media text-color-lightgray"><i class="f7-icons icon-tracking"></i></div>
                            <div class="item-inner">
                                <div class="item-title">{{Address}}</div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>


        </div>


    </div>
</template>


<script>
    // script must return component object
    return {
        data: function () {
            let ret = {
                Name: 'test',
                Phone: '+1234567890',
                Email: 'test@test.com',
                Address: 'Loading...',
            };

            return ret;
        },
        methods: {
            refreshMap: function () {
                let self = this;

                /*bgGeo.requestPermission().then((status) => {

                }).catch((status) => {
                    self.$app.methods.customDialog({text: LANGUAGE.PROMPT_MSG008});
                    console.log('[requestPermission] REJECTED', status);
                });*/
                if (!bgGeo){
                    self.$app.methods.customDialog({text:LANGUAGE.PROMPT_MSG006});
                    return;
                }
                self.$app.progressbar.show('gray');
                bgGeo.getCurrentPosition({
                    timeout: 30,          // 30 second timeout to fetch location
                    persist: true,        // Defaults to state.enabled
                    maximumAge: 5000,     // Accept the last-known-location if not older than 5000 ms.
                    desiredAccuracy: 10,  // Try to fetch a location with an accuracy of `10` meters.
                    samples: 3,           // How many location samples to attempt.
                }, function(location){
                    //alert(JSON.stringify(location));
                    self.$app.progressbar.hide();
                    if(self.$app.methods.isObjEmpty(location)){
                        self.$app.methods.customDialog({text:LANGUAGE.TRACKING_PLUGIN_MSG05});
                        return;
                    }

                    if(!self.Marker){
                        self.Marker = L.marker([location.coords.latitude, location.coords.longitude], {icon: Helper.MarkerIcon[0]});
                        self.Marker.addTo(self.Map);
                    }
                    self.Marker.setLatLng([location.coords.latitude, location.coords.longitude]);
                    self.Map.setView([location.coords.latitude, location.coords.longitude]);
                    Helper.Methods.getAddressByGeocoder({lat: location.coords.latitude, lng: location.coords.longitude}, function (address) {
                        self.$setState({
                            Address: address
                        })
                    })

                    /* let pBattery = parseInt(location.battery.level * 100) + '%';
                     let pSpeed = '0m/s';
                     if (location.coords.speed > 0){
                         pSpeed = parseFloat(location.coords.speed).toFixed(2) + 'm/s';
                     }
                     let pHeading = Helper.Methods.getDirectionCardinal(location.coords.heading);


                     let message = `${ LANGUAGE.PROMPT_MSG015 } https://www.google.com/maps?q=${ location.coords.latitude },${ location.coords.longitude }. ${ LANGUAGE.PROMPT_MSG016 } ${ pBattery }, ${ LANGUAGE.PROMPT_MSG017 } ${ pSpeed }, ${ LANGUAGE.PROMPT_MSG018 } ${ pHeading }`;
                     let numbers = [];
                     for (let i = 0; i < panicConfig.SMSTo.length; i++) {
                         numbers.push( emergencyList.find( ({ Id }) => Id === panicConfig.SMSTo[i] ).Phone );
                     }*/

                },function(errorCode){
                    self.$app.progressbar.hide();
                    let errorMsg = LANGUAGE.TRACKING_PLUGIN_MSG04;
                    switch (errorCode) {
                        case 0:
                            errorMsg = LANGUAGE.TRACKING_PLUGIN_MSG00;
                            break;
                        case 1:
                            errorMsg = LANGUAGE.TRACKING_PLUGIN_MSG01;
                            break;
                        case 2:
                            errorMsg = LANGUAGE.TRACKING_PLUGIN_MSG02;
                            break;
                        case 408:
                            errorMsg = LANGUAGE.TRACKING_PLUGIN_MSG03;
                            break;
                    }
                    self.$app.methods.customDialog({text:errorMsg});
                });
            }
        },

        on: {
            pageInit: function (e, page) {
                let self = this;

                self.Map = Helper.Methods.createMap({ target: 'homeMap', latLng: [9.675228, -171.364896], zoom: 2 });

                LoginEvents.on('signedIn', function (userInfo){
                    self.$setState({
                        LoginDone: true,

                        Name: (userInfo.FirstName + ' ' + userInfo.SubName).trim(),
                        Phone: userInfo.Mobile,
                        Email: userInfo.EMail,
                    });

                });
                LoginEvents.on('signedOut', function (){
                    //self.VirtualAssetListMain.deleteAllItems();
                    self.$setState({
                        LoginDone: false
                    })
                });

            },
            pageBeforeRemove: function () {
                LoginEvents.off('signedIn');
                LoginEvents.off('signedOut');
            }


        }
    };
</script>